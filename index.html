<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B√†i Ki·ªÉm Tra Vui Nh·ªôn üéà</title>
  <style>
    :root {
      --bg: #f7fbff;
      --card: #ffffff;
      --text: #243b53;
      --primary: #6c5ce7;
      --primary-dark: #5847d1;
      --accent: #00c2ff;
      --success: #2ecc71;
      --danger: #ff4757;
      --warning: #f39c12;
      --soft: #eef5ff
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: linear-gradient(135deg, #fdfbff 0%, #ecf5ff 40%, #f8fffe 100%);
    }

    .container {
      max-width: 980px;
      margin: 24px auto;
      padding: 16px;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .06);
      padding: 20px;
    }

    header.hero {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), #7ed6df);
      color: white;
      box-shadow: 0 10px 25px rgba(108, 92, 231, .35);
    }

    .mascot {
      font-size: 38px;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, .2));
    }

    .title h1 {
      margin: 0;
      font-size: 26px;
    }

    .title p {
      margin: 2px 0 0;
      opacity: .95
    }

    .hud {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin: 16px 0
    }

    .hud-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .progress {
      flex: 1;
      min-width: 220px;
      background: #eaf1ff;
      border-radius: 999px;
      height: 14px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, .08)
    }

    .progress>div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), #00e5a8);
      transition: width .35s ease;
    }

    .hud-right {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--soft);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700
    }

    .pill .num {
      font-variant-numeric: tabular-nums
    }

    .file-input-section {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin: 16px 0
    }

    .file-input-section .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    select,
    input[type="file"],
    input[type="number"] {
      padding: 10px 12px;
      border: 1px solid #dfe7ff;
      border-radius: 10px;
      background: white;
      font-size: 14px;
    }

    input[type="number"] {
      width: 84px;
      text-align: center
    }

    button {
      border: none;
      background: var(--primary);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(108, 92, 231, .3);
      transition: .2s transform, .2s background
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px)
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
      transform: none
    }

    #loadQuizBtn {
      width: 100%;
    }

    .quiz-section {
      margin-top: 10px
    }

    .question-item {
      position: relative;
      margin: 12px 0 18px;
      padding: 16px;
      border: 1px solid #e7efff;
      border-radius: 16px;
      background: #ffffff
    }

    .question-item p {
      margin: 0 0 10px;
      font-weight: 800
    }

    .options {
      display: grid;
      gap: 10px
    }

    .option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e8edff;
      background: #fbfdff;
      cursor: pointer;
      transition: .15s background, .15s transform
    }

    .option:hover {
      background: #f2f7ff
    }

    .option input {
      transform: scale(1.25)
    }

    .correct-answer-highlight {
      background: #eafff3 !important;
      border-color: var(--success)
    }

    .incorrect-answer-highlight {
      background: #fff0f0 !important;
      border-color: var(--danger)
    }

    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px
    }

    .btn-subtle {
      background: #ecf2ff;
      color: #2d3a63;
      box-shadow: none
    }

    .feedback-message {
      font-weight: 800;
      margin-top: 12px;
      padding: 10px;
      border-radius: 12px;
      text-align: center
    }

    .feedback-correct {
      background: #eafff3;
      color: #23a85b;
      border: 1px solid #b5f1cc
    }

    .feedback-incorrect {
      background: #fff0f0;
      color: #e74c3c;
      border: 1px solid #ffd0d0
    }

    .results-section {
      margin-top: 20px;
      display: none;
      background: #f3f8ff;
      border: 1px solid #d8e6ff;
      border-radius: 16px;
      padding: 16px
    }

    .results-section h2 {
      margin-top: 0;
      text-align: center
    }

    .results-section ul {
      list-style: none;
      padding: 0;
      margin: 0
    }

    .results-section li {
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 10px;
      border: 1px solid #cfe2ff
    }

    .result-answer.correct-text {
      color: var(--success);
      font-weight: 800
    }

    .result-answer.incorrect-text {
      color: var(--danger);
      font-weight: 800
    }

    .coach {
      margin-top: 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px
    }

    .coach .avatar {
      font-size: 30px
    }

    .coach .bubble {
      background: #fff;
      border: 1px solid #e6ecff;
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .06);
      flex: 1;
    }

    #confetti {
      pointer-events: none;
      position: fixed;
      inset: 0;
      overflow: hidden
    }

    .confetto {
      position: absolute;
      width: 10px;
      height: 14px;
      border-radius: 3px;
      opacity: 0;
      animation: confettiFall 900ms linear forwards
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(-10vh) rotate(0deg);
        opacity: 1
      }

      100% {
        transform: translateY(100vh) rotate(540deg);
        opacity: 0
      }
    }

    .pop {
      animation: pop .4s ease
    }

    @keyframes pop {
      0% {
        transform: scale(.9)
      }

      60% {
        transform: scale(1.05)
      }

      100% {
        transform: scale(1)
      }
    }

    .shake {
      animation: shake .35s ease
    }

    @keyframes shake {
      10% {
        transform: translateX(-3px)
      }

      30% {
        transform: translateX(3px)
      }

      50% {
        transform: translateX(-3px)
      }

      70% {
        transform: translateX(3px)
      }

      100% {
        transform: none
      }
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal .box {
      background: white;
      border-radius: 18px;
      padding: 18px;
      width: min(92vw, 420px);
      text-align: center;
      box-shadow: 0 14px 40px rgba(0, 0, 0, .25)
    }

    .stickers {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 8px 0
    }

    .sticker {
      font-size: 36px;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, .15))
    }

    .sticker-board {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 8px;
      min-height: 54px;
      border: 1px dashed #d7dcff;
      border-radius: 12px;
      background: #fcfeff
    }

    .center {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        margin: 12px auto;
        padding: 12px;
      }

      .card {
        padding: 16px;
        border-radius: 14px;
      }

      header.hero {
        flex-direction: row;
        gap: 12px;
        padding: 12px;
      }

      .mascot {
        font-size: 32px;
      }

      .title h1 {
        font-size: 20px;
      }

      .title p {
        font-size: 14px;
      }

      .hud {
        flex-direction: column;
        gap: 10px;
      }

      .hud-left {
        width: 100%;
      }

      .hud-right {
        width: 100%;
        justify-content: flex-start;
      }

      .progress {
        min-width: 100%;
      }

      .file-input-section .row {
        flex-direction: column;
        align-items: stretch;
      }

      .file-input-section .row label {
        width: 100%;
      }

      .file-input-section .row select,
      .file-input-section .row input {
        width: 100%;
      }

      input[type="number"] {
        width: 100%;
      }

      button {
        width: 100%;
        padding: 14px;
      }

      .btn-row {
        flex-direction: column;
      }

      .btn-row button {
        width: 100%;
      }

      .center {
        flex-direction: column;
      }

      .center button {
        width: 100%;
      }

      .question-item {
        padding: 12px;
      }

      .coach {
        flex-direction: row;
        gap: 8px;
      }

      .coach .avatar {
        font-size: 24px;
      }

      .coach .bubble {
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .container {
        margin: 8px auto;
        padding: 8px;
      }

      .card {
        padding: 12px;
      }

      .mascot {
        font-size: 28px;
      }

      .title h1 {
        font-size: 18px;
      }

      .option {
        padding: 8px 10px;
        font-size: 14px;
      }

      select,
      input {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card" style="padding:0; overflow:hidden">
      <header class="hero">
        <div class="mascot">ü¶Ñ</div>
        <div class="title">
          <h1>B√†i Ki·ªÉm Tra Vui Nh·ªôn</h1>
          <p>C√πng h·ªçc m√† ch∆°i ‚Äì ch∆°i m√† h·ªçc!</p>
        </div>
      </header>

      <div class="hud">
        <div class="hud-left">
          <div class="progress" aria-label="Ti·∫øn ƒë·ªô l√†m b√†i">
            <div id="progressBar"></div>
          </div>
        </div>
        <div class="hud-right">
          <!-- Voice selector (ALWAYS ON speaking; no toggle) -->
          <label for="voiceSelect"><strong>üó£Ô∏è</strong></label>
          <select id="voiceSelect">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">English</option>
          </select>
        </div>
      </div>

      <div class="file-input-section card" style="margin: 12px;">
        <div class="row">
          <label for="topicSelect"><strong>Ch·ªçn ch·ªß ƒë·ªÅ c√≥ s·∫µn:</strong></label>
          <select id="topicSelect">
            <option value="">-- T·ª± ch·ªçn t·ªáp b√™n d∆∞·ªõi --</option>
          </select>
        </div>
        <div class="row" style="justify-content:center; opacity:.8">HO·∫∂C</div>
        <div class="row">
          <label for="jsonFile"><strong>T·∫£i t·ªáp c√¢u h·ªèi (JSON):</strong></label>
          <input type="file" id="jsonFile" accept=".json" />
        </div>
        <div class="row">
          <label for="numQuestionsInput"><strong>S·ªë l∆∞·ª£ng c√¢u h·ªèi:</strong></label>
          <input type="number" id="numQuestionsInput" value="10" min="1" />
          <label for="quizModeSelect"><strong>Ch·∫ø ƒë·ªô:</strong></label>
          <select id="quizModeSelect">
            <option value="single">T·ª´ng c√¢u</option>
            <option value="all">T·∫•t c·∫£</option>
          </select>
          <button id="loadQuizBtn" disabled>B·∫Øt ƒë·∫ßu l√†m b√†i üöÄ</button>
        </div>
      </div>

      <div id="quizContainer" class="quiz-section card" style="margin: 12px;"></div>

      <div class="center" style="margin: 12px 0 16px;">
        <button id="submitQuizBtn" disabled>Ki·ªÉm tra</button>
        <button id="newQuizBtn" disabled class="btn-subtle">L√†m b√†i m·ªõi</button>
      </div>

      <div id="resultsSection" class="results-section card" style="margin: 12px;">
        <h2>K·∫øt qu·∫£ c·ªßa b·∫°n</h2>
        <div class="sticker-board" id="stickerBoard" aria-label="B·∫£ng sticker c·ªßa b·∫°n"></div>
        <p id="scoreDisplay" style="font-size:1.1em; font-weight:800; text-align:center"></p>
        <h3>Chi ti·∫øt:</h3>
        <ul id="resultsList"></ul>
      </div>

      <div class="coach" style="margin: 0 12px 16px;">
        <div class="avatar">ü¶ä</div>
        <div id="coachBubble" class="bubble">Ch·ªçn ch·ªß ƒë·ªÅ v√† nh·∫•n <strong>B·∫Øt ƒë·∫ßu l√†m b√†i</strong> nh√©!</div>
      </div>
    </div>
  </div>

  <!-- Confetti container -->
  <div id="confetti" aria-hidden="true"></div>

  <!-- Sticker modal -->
  <div id="stickerModal" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <div style="font-size:42px">üéÅ</div>
      <h3>Ph·∫ßn th∆∞·ªüng cho b·∫°n!</h3>
      <p>B·∫°n v·ª´a m·ªü kh√≥a sticker m·ªõi, h√£y s∆∞u t·∫ßm nh√©.</p>
      <div class="stickers" id="stickerChoices"></div>
      <div class="center">
        <button id="closeSticker" class="btn-subtle">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script>
    // ==== C·∫§U H√åNH ==== //
    const availableTopics = {
      "topic/nguphapA1.json": "Ng·ªØ ph√°p A1 l·ªõp 3",
      "topic/nguphapA2.json": "Ng·ªØ ph√°p A2 l·ªõp 4",
      "topic/chuyenthapphan.json": "Chuy·ªÉn ph√¢n s·ªë",
      "topic/nhanchiatronchuc.json": "Nh√¢n chia 10 v√† 0,1",
      "topic/doidonvi.json": "ƒê·ªïi ƒë∆°n v·ªã",
      "topic/sosanhlop1.json": "So s√°nh To√°n 1",
      "topic/toan1loigiai.json": "To√°n 1 l·ªùi gi·∫£i"
    };

    // ==== TR·∫†NG TH√ÅI ==== //
    let allQuestions = [];
    let currentQuizQuestions = [];
    let userSelections = {}; // {index: option}
    let quizMode = 'single';
    let currentQuestionIndex = 0;
    let totalScore = 0;

    // Ch·ªâ l∆∞u gi·ªçng ƒë·ªçc c√¢u h·ªèi (m·∫∑c ƒë·ªãnh vi-VN). L·ªùi kh√≠ch l·ªá lu√¥n vi-VN.
    const settings = {
      voiceLang: localStorage.getItem('kidsquiz_voiceLang') || 'vi-VN'
    };

    // UI Elements
    const jsonFileInput = document.getElementById('jsonFile');
    const topicSelect = document.getElementById('topicSelect');
    const numQuestionsInput = document.getElementById('numQuestionsInput');
    const quizModeSelect = document.getElementById('quizModeSelect');
    const loadQuizBtn = document.getElementById('loadQuizBtn');
    const quizContainer = document.getElementById('quizContainer');
    const submitQuizBtn = document.getElementById('submitQuizBtn');
    const newQuizBtn = document.getElementById('newQuizBtn');
    const resultsSection = document.getElementById('resultsSection');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const resultsList = document.getElementById('resultsList');
    const progressBar = document.getElementById('progressBar');
    const coachBubble = document.getElementById('coachBubble');
    const voiceSelect = document.getElementById('voiceSelect');

    const confettiBox = document.getElementById('confetti');
    const stickerBoard = document.getElementById('stickerBoard');
    const stickerModal = document.getElementById('stickerModal');
    const stickerChoices = document.getElementById('stickerChoices');
    const closeSticker = document.getElementById('closeSticker');

    const STICKERS = ['ü¶Ñ', 'üêº', 'üêØ', 'üê∂', 'üê±', 'ü¶Å', 'üê∑', 'üê∏', 'üê®', 'ü¶ä', 'ü¶ñ', 'üê≥', 'ü™ê', 'üöÄ', 'üåà', 'üç≠', 'üçé', 'üéπ', 'üé®', '‚öΩÔ∏è'];

    // ==== √ÇM THANH (lu√¥n b·∫≠t) ==== //
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    function resumeAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }
    document.addEventListener('click', resumeAudio, { once: true, capture: true });

    function beep(freq = 440, duration = 120, type = 'sine', volume = 0.15) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.value = freq; gain.gain.value = volume;
      osc.connect(gain).connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      osc.start(now);
      osc.stop(now + duration / 1000);
    }
    function arpeggio(freqs = [], step = 90) { let t = 0; freqs.forEach(f => { setTimeout(() => beep(f, step, 'triangle'), t); t += step; }); }
    function soundCorrect() { arpeggio([523, 659, 784, 1046], 90); }
    function soundIncorrect() { arpeggio([220, 196, 174], 140); }
    function soundReward() { arpeggio([659, 784, 988, 1319, 1760], 80); }

    // ==== GI·ªåNG N√ìI ==== //
    // C·∫£i thi·ªán vi·ªác ch·ªçn gi·ªçng ƒë·ªçc ƒë·ªÉ tr√°nh ƒë·ªçc sai ng√¥n ng·ªØ
    function pickVoice(lang) {
      const voices = speechSynthesis.getVoices();

      // Th·ª≠ t√¨m gi·ªçng ch√≠nh x√°c v·ªõi m√£ ng√¥n ng·ªØ ƒë·∫ßy ƒë·ªß (v√≠ d·ª•: vi-VN)
      let voice = voices.find(v => v.lang && v.lang.toLowerCase() === lang.toLowerCase());
      if (voice) return voice;

      // Th·ª≠ t√¨m gi·ªçng v·ªõi m√£ ng√¥n ng·ªØ ng·∫Øn (v√≠ d·ª•: vi)
      const shortLang = lang.split('-')[0];
      voice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith(shortLang.toLowerCase()));
      if (voice) return voice;

      // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m gi·ªçng m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng
      voice = voices.find(v => v.default);
      if (voice) return voice;

      // Cu·ªëi c√πng, tr·∫£ v·ªÅ gi·ªçng ƒë·∫ßu ti√™n n·∫øu c√≥
      return voices.length > 0 ? voices[0] : null;
    }

    // L·ªùi kh√≠ch l·ªá: lu√¥n ti·∫øng Vi·ªát
    function speakCoach(text) {
      try {
        const u = new SpeechSynthesisUtterance(text);
        const v = pickVoice('vi-VN');
        if (v) {
          u.voice = v;
          console.log('Coach voice:', v.name, v.lang);
        }
        u.lang = 'vi-VN';
        u.rate = 1;
        speechSynthesis.speak(u);
      } catch (e) {
        console.error('Speech error:', e);
      }
    }

    // ƒê·ªçc c√¢u h·ªèi: theo gi·ªçng user ch·ªçn
    function speakQuestion(text) {
      try {
        const lang = settings.voiceLang || 'vi-VN';
        const u = new SpeechSynthesisUtterance(text);
        const v = pickVoice(lang);
        if (v) {
          u.voice = v;
          console.log('Question voice:', v.name, v.lang);
        }
        u.lang = lang;
        u.rate = 1;
        speechSynthesis.speak(u);
      } catch (e) {
        console.error('Speech error:', e);
      }
    }

    // ƒê·∫£m b·∫£o danh s√°ch gi·ªçng ƒë∆∞·ª£c t·∫£i
    let voicesLoaded = false;
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0 && !voicesLoaded) {
        voicesLoaded = true;
        console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
      }
    }
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices(); // Th·ª≠ t·∫£i ngay

    // ==== TI·ªÜN √çCH ==== //
    function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } return array; }
    function updateLoadButtonState() { loadQuizBtn.disabled = !(jsonFileInput.files.length > 0 || topicSelect.value !== ""); }

    jsonFileInput.addEventListener('change', () => { if (jsonFileInput.files.length > 0) { topicSelect.value = ""; } updateLoadButtonState(); });
    topicSelect.addEventListener('change', () => { if (topicSelect.value !== "") { jsonFileInput.value = ""; } updateLoadButtonState(); });

    quizModeSelect.addEventListener('change', (e) => { quizMode = e.target.value; updateSubmitButtonText(); });

    // Voice select (lu√¥n b·∫≠t)
    voiceSelect.value = settings.voiceLang;
    voiceSelect.addEventListener('change', () => {
      settings.voiceLang = voiceSelect.value;
      localStorage.setItem('kidsquiz_voiceLang', settings.voiceLang);
      speakCoach('ƒê√£ chuy·ªÉn gi·ªçng ƒë·ªçc c√¢u h·ªèi.');
    });

    loadQuizBtn.addEventListener('click', () => {
      resumeAudio();
      if (topicSelect.value) {
        loadQuizFromTopic(topicSelect.value);
      } else if (jsonFileInput.files.length > 0) {
        loadQuizFromFile(jsonFileInput.files[0]);
      } else {
        alert('Vui l√≤ng ch·ªçn ch·ªß ƒë·ªÅ ho·∫∑c t·∫£i l√™n m·ªôt t·ªáp JSON.');
      }
    });

    function loadQuizFromTopic(filePath) {
      fetch(filePath).then(r => { if (!r.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i t·ªáp: ${r.statusText}`); return r.json(); })
        .then(processLoadedQuestions)
        .catch(err => { alert('L·ªói khi t·∫£i t·ªáp ch·ªß ƒë·ªÅ: ' + err.message); console.error(err); });
    }

    function loadQuizFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => processLoadedQuestions(JSON.parse(e.target.result));
      reader.onerror = () => alert('L·ªói khi ƒë·ªçc t·ªáp.');
      reader.readAsText(file);
    }

    function processLoadedQuestions(loadedData) {
      try {
        allQuestions = loadedData.map(q => {
          if (!q.question || !Array.isArray(q.options) || q.options.length === 0 || !q.correctAnswer) {
            throw new Error('M·ªôt c√¢u h·ªèi c√≥ c·∫•u tr√∫c kh√¥ng h·ª£p l·ªá.');
          }
          let correctAnswer = q.correctAnswer;
          if (Array.isArray(correctAnswer)) {
            if (correctAnswer.length !== 1) throw new Error(`C√¢u h·ªèi "${q.question}" c√≥ nhi·ªÅu h∆°n 1 ƒë√°p √°n ƒë√∫ng.`);
            correctAnswer = correctAnswer[0];
          }
          if (typeof correctAnswer !== 'string' || correctAnswer.trim() === '') {
            throw new Error(`ƒê√°p √°n ƒë√∫ng c·ªßa c√¢u h·ªèi "${q.question}" kh√¥ng h·ª£p l·ªá.`);
          }
          return { ...q, correctAnswer: correctAnswer.trim() };
        });
        startNewQuiz();
      } catch (error) { alert('L·ªói x·ª≠ l√Ω d·ªØ li·ªáu JSON: ' + error.message); console.error(error); resetQuizState(); }
    }

    function updateSubmitButtonText() { submitQuizBtn.textContent = (quizMode === 'single') ? 'Ki·ªÉm tra' : 'N·ªôp b√†i v√† Xem k·∫øt qu·∫£'; }

    function startNewQuiz() {
      resetQuizState();
      let num = parseInt(numQuestionsInput.value, 10) || 10;
      const shuffled = shuffleArray([...allQuestions]);
      currentQuizQuestions = shuffled.slice(0, num);
      if (currentQuizQuestions.length < num) { alert(`Ch·ªâ c√≥ ${currentQuizQuestions.length} c√¢u h·ªèi. S·∫Ω hi·ªÉn th·ªã t·∫•t c·∫£.`); numQuestionsInput.value = currentQuizQuestions.length; }

      [loadQuizBtn, jsonFileInput, topicSelect, numQuestionsInput, quizModeSelect].forEach(el => el.disabled = true);
      submitQuizBtn.disabled = false;

      coachBubble.innerHTML = 'C·ªë l√™n n√†o! Ch·ªçn ƒë√°p √°n ƒë√∫ng nh√©!';
      updateProgress();

      if (quizMode === 'all') displayAllQuestions(); else displayCurrentQuestion();
      updateSubmitButtonText();
    }



    function updateProgress() {
      const total = currentQuizQuestions.length || 1;
      const done = (quizMode === 'single') ? currentQuestionIndex : Object.keys(userSelections).length;
      const pct = Math.min(100, Math.round((done / total) * 100));
      progressBar.style.width = pct + '%';
    }

    function displayAllQuestions() { currentQuizQuestions.forEach((q, idx) => quizContainer.appendChild(createQuestionElement(q, idx))); }

    function displayCurrentQuestion() {
      if (currentQuestionIndex < currentQuizQuestions.length) {
        const q = currentQuizQuestions[currentQuestionIndex];
        quizContainer.innerHTML = '';
        quizContainer.appendChild(createQuestionElement(q, currentQuestionIndex));
        submitQuizBtn.textContent = 'Ki·ªÉm tra';
        submitQuizBtn.disabled = false;
        updateProgress();
      } else { showFinalResults(); }
    }

    function createQuestionElement(q, index) {
      const wrap = document.createElement('div'); wrap.className = 'question-item pop'; wrap.dataset.questionIndex = index;

      const p = document.createElement('p'); p.textContent = `${index + 1}. ${q.question}`; wrap.appendChild(p);

      const opts = document.createElement('div'); opts.className = 'options'; wrap.appendChild(opts);

      const shuffledOpts = shuffleArray([...q.options]);
      shuffledOpts.forEach(option => {
        const label = document.createElement('label'); label.className = 'option';
        const radio = document.createElement('input'); radio.type = 'radio'; radio.name = `question-${index}`; radio.value = option;
        if (userSelections[index] === option) { radio.checked = true; }
        radio.addEventListener('change', () => { userSelections[index] = radio.value; });
        label.appendChild(radio); label.appendChild(document.createTextNode(option));
        opts.appendChild(label);
      });

      const btnRow = document.createElement('div'); btnRow.className = 'btn-row'; wrap.appendChild(btnRow);

      // N√∫t ƒë·ªçc c√¢u h·ªèi (theo gi·ªçng ƒë√£ ch·ªçn)
      const readBtn = document.createElement('button'); readBtn.className = 'btn-subtle'; readBtn.textContent = 'ƒê·ªçc c√¢u h·ªèi üîà';
      readBtn.addEventListener('click', () => speakQuestion(q.question));
      btnRow.appendChild(readBtn);

      if (quizMode === 'single') {
        const fb = document.createElement('div'); fb.id = `feedback-${index}`; fb.className = 'feedback-message'; fb.style.display = 'none'; wrap.appendChild(fb);
      }

      return wrap;
    }

    submitQuizBtn.addEventListener('click', () => {
      if (quizMode === 'all') processAllQuestionsAtOnce();
      else {
        if (submitQuizBtn.textContent === 'Ki·ªÉm tra') { processSingleQuestionCheck(); }
        else { moveToNextSingleQuestion(); }
      }
    });

    function processSingleQuestionCheck() {
      const q = currentQuizQuestions[currentQuestionIndex];
      const wrap = quizContainer.querySelector(`[data-question-index="${currentQuestionIndex}"]`);
      const feedbackDiv = document.getElementById(`feedback-${currentQuestionIndex}`);
      const selected = userSelections[currentQuestionIndex];

      if (!selected) { wrap.classList.add('shake'); setTimeout(() => wrap.classList.remove('shake'), 400); coachBubble.textContent = 'H√£y ch·ªçn m·ªôt ƒë√°p √°n tr∆∞·ªõc ƒë√£ nh√©!'; beep(300, 120); return; }

      wrap.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
      const isCorrect = selected === q.correctAnswer;

      highlightQuestion(wrap, selected, q.correctAnswer);

      if (isCorrect) {
        totalScore++; soundCorrect(); speakCoach('Gi·ªèi l·∫Øm!');
        coachBubble.innerHTML = 'Tuy·ªát v·ªùi! Ti·∫øp t·ª•c nh√©!';
        feedbackDiv.textContent = 'Ch√≠nh x√°c! üéâ'; feedbackDiv.className = 'feedback-message feedback-correct';
        burstConfetti();
      } else {
        soundIncorrect(); speakCoach('Ch∆∞a ƒë√∫ng. Th·ª≠ l·∫°i ·ªü c√¢u sau nh√©!');
        coachBubble.innerHTML = `√îi! ƒê√°p √°n ƒë√∫ng l√† <strong>${q.correctAnswer}</strong>. Kh√¥ng sao, m√¨nh ti·∫øp t·ª•c n√†o!`;
        feedbackDiv.innerHTML = `Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†: <strong>${q.correctAnswer}</strong>`; feedbackDiv.className = 'feedback-message feedback-incorrect';
      }

      feedbackDiv.style.display = 'block';
      submitQuizBtn.textContent = 'Ti·∫øp t·ª•c';
      updateProgress();
    }

    function moveToNextSingleQuestion() { currentQuestionIndex++; displayCurrentQuestion(); }

    function processAllQuestionsAtOnce() {
      totalScore = 0;
      quizContainer.querySelectorAll('.question-item').forEach((wrap, idx) => {
        const q = currentQuizQuestions[idx];
        const selected = userSelections[idx];
        const isCorrect = selected === q.correctAnswer;
        if (isCorrect) { totalScore++; }
        wrap.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
        highlightQuestion(wrap, selected, q.correctAnswer);
      });
      showFinalResults();
    }

    function highlightQuestion(wrap, selected, correct) {
      wrap.querySelectorAll('.option').forEach(label => {
        const val = label.querySelector('input').value;
        if (val === correct) { label.classList.add('correct-answer-highlight'); }
        if (val === selected && selected !== correct) { label.classList.add('incorrect-answer-highlight'); }
      });
    }

    function showFinalResults() {
      quizContainer.innerHTML = '';
      scoreDisplay.textContent = `B·∫°n ƒë√£ ƒë·∫°t ${totalScore} / ${currentQuizQuestions.length} ƒëi·ªÉm.`;
      resultsList.innerHTML = '';

      currentQuizQuestions.forEach((q, idx) => {
        const selected = userSelections[idx];
        const isCorrect = selected === q.correctAnswer;
        const li = document.createElement('li');
        li.style.backgroundColor = isCorrect ? '#eafff3' : '#fff0f0';
        li.style.borderColor = isCorrect ? '#2ecc71' : '#ff4757';
        let answerHtml = `C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: <span class="result-answer ${isCorrect ? 'correct-text' : 'incorrect-text'}">${selected || 'Ch∆∞a tr·∫£ l·ªùi'}</span>`;
        if (!isCorrect) { answerHtml += `<br>ƒê√°p √°n ƒë√∫ng: <span class="result-answer correct-text">${q.correctAnswer}</span>`; }
        li.innerHTML = `<strong>C√¢u ${idx + 1}: ${q.question}</strong><br>${answerHtml}`;
        resultsList.appendChild(li);
      });

      resultsSection.style.display = 'block';
      submitQuizBtn.disabled = true; newQuizBtn.disabled = false;

      const ratio = (totalScore / currentQuizQuestions.length);
      if (ratio >= 0.8) { openStickerReward(); soundReward(); speakCoach('Tuy·ªát v·ªùi! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng.'); burstConfetti(2); }
      coachBubble.innerHTML = 'Xem l·∫°i ƒë√°p √°n v√† nh·∫•n <strong>L√†m b√†i m·ªõi</strong> ƒë·ªÉ ch∆°i ti·∫øp nh√©!';
    }

    newQuizBtn.addEventListener('click', () => {
      [jsonFileInput, topicSelect, numQuestionsInput, quizModeSelect].forEach(el => el.disabled = false);
      startNewQuiz();
    });

    function resetQuizState() {
      quizContainer.innerHTML = ''; resultsSection.style.display = 'none';
      userSelections = {}; currentQuestionIndex = 0; totalScore = 0;
      submitQuizBtn.disabled = true; newQuizBtn.disabled = true; updateSubmitButtonText(); updateProgress();
    }

    // ==== CONFETTI ==== //
    function burstConfetti(times = 1) {
      for (let t = 0; t < times; t++) {
        setTimeout(() => {
          for (let i = 0; i < 36; i++) {
            const d = document.createElement('div'); d.className = 'confetto';
            const hue = Math.floor(Math.random() * 360);
            d.style.background = `hsl(${hue} 90% 60%)`;
            d.style.left = Math.random() * 100 + 'vw';
            d.style.top = '-10vh';
            d.style.animationDuration = (700 + Math.random() * 500) + 'ms';
            confettiBox.appendChild(d);
            setTimeout(() => d.remove(), 1200);
          }
        }, t * 250);
      }
    }

    // ==== STICKERS ==== //
    function openStickerReward() {
      stickerChoices.innerHTML = '';
      shuffleArray([...STICKERS]).slice(0, 5).forEach(s => {
        const span = document.createElement('span'); span.className = 'sticker'; span.textContent = s;
        span.style.cursor = 'pointer';
        span.addEventListener('click', () => { addStickerToBoard(s); closeStickerModal(); });
        stickerChoices.appendChild(span);
      });
      stickerModal.style.display = 'flex';
    }
    function closeStickerModal() { stickerModal.style.display = 'none'; }
    function addStickerToBoard(s) { const e = document.createElement('span'); e.className = 'sticker'; e.textContent = s; stickerBoard.appendChild(e); }
    closeSticker.addEventListener('click', closeStickerModal);

    // ==== KH·ªûI T·∫†O ==== //
    window.onload = () => {
      for (const path in availableTopics) {
        const o = document.createElement('option');
        o.value = path;
        o.textContent = availableTopics[path];
        topicSelect.appendChild(o);
      }
      resetQuizState();
      updateLoadButtonState();

      // Th√™m c√°c d√≤ng n√†y ƒë·ªÉ ƒë·∫£m b·∫£o ng√¥n ng·ªØ lu√¥n ƒë∆∞·ª£c ƒë·∫∑t l·∫°i th√†nh Ti·∫øng Vi·ªát
      const defaultLanguage = 'vi-VN';
      settings.voiceLang = defaultLanguage; // C·∫≠p nh·∫≠t bi·∫øn tr·∫°ng th√°i
      voiceSelect.value = defaultLanguage; // C·∫≠p nh·∫≠t hi·ªÉn th·ªã tr√™n giao di·ªán
      localStorage.setItem('kidsquiz_voiceLang', defaultLanguage); // Ghi ƒë√® gi√° tr·ªã c≈© trong localStorage
    };
  </script>
</body>

</html>